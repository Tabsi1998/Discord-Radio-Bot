<analysis>**original_problem_statement:**
The user has requested a complete rebranding of the existing Discord Radio Bot to a new product called OmniFM. This includes a comprehensive overhaul of the architecture and monetization model to a professional, scalable system.

**PRODUCT REQUIREMENTS (Monetization System v3 & Rebrand):**
1.  **Rebrand**: Systematically replace all instances of RADIOBOT with OmniFM, including UI strings, logs, and bot presence.
2.  **Plans & Features**: Implement a strict three-tier system (free, pro, ultimate) with feature flags managed in a central config ().
3.  **Server-Based Licensing**: Shift from a guild-based model to a server-seat bundle model. A single license can cover multiple servers (1, 2, 3, or 5 seats).
4.  **Station Tier System**: Segment stations into                total        used        free      shared  buff/cache   available
Mem:        16358500     4814364     5282672       45532     6584388    11544136
Swap:              0           0           0 (20 stations) and  (100 stations). The  plan includes all stations plus server-specific custom station URLs.
5.  **Command Permission Matrix**: Strictly enforce plan-based access for all commands, especially , , and quality settings. Deny access with a clear upgrade message.
6.  **Reconnect Priority**: Implement tiered reconnect delays: standard for free, faster for pro, and instant for ultimate.
7.  **Audio Quality Enforcement**: Cap audio bitrates based on the server's plan (Free: 64k, Pro: 128k, Ultimate: 320k).
8.  **Pricing System**: Implement a pricing calculator () for different plans, seat bundles, and billing periods (monthly/yearly) with a yearly discount.
9.  **Website Copy Update**: Update the static website to reflect the new OmniFM branding, features, and pricing tiers.
10. **Upgrade Flow**: Create a reusable module for sending clear, helpful upgrade embeds within Discord when a user hits a feature paywall.

**User's preferred language**: German. The next agent MUST respond in German.

**what currently exists?**
The agent has begun the massive rebranding and architectural refactoring from RadioBot to OmniFM. It has successfully laid the groundwork by creating several new, modular files for configuration, services, and data. The project is in a transitional, non-functional state as the core logic has not yet been updated to use these new modules. The previous critical bugs related to the  script and auto-reconnect functionality have been resolved.

**Last working item**:
- Last item agent was working: The agent was in the middle of the OmniFM refactoring. It had just created the new modules for plans, pricing, entitlements, and station management, and was about to begin the most critical part: refactoring the monolithic  to integrate these new services and apply the new permission model and branding.
- Status: IN PROGRESS
- Agent Testing Done: N (The application is in a broken, mid-refactor state)
- Which testing method agent to use? **testing agent v3 fork**. A comprehensive E2E test will be mandatory after the refactoring is complete to validate the new architecture, permissions, and branding.
- User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) The application is non-functional due to the incomplete OmniFM rebranding and architectural refactor.

Issues Detail:
-   **Issue 1: Incomplete OmniFM Refactor**
    -   **Attempted fixes**: The agent has created the foundational files for the new architecture (, , , , , ) and updated  and .
    -   **Next debug checklist**:
        1.  Continue the refactor of . Systematically replace old logic with calls to the new services (, , ).
        2.  Enforce the new permission model within all Discord command handlers ( event). Use  and  helpers.
        3.  Update the audio playback logic to enforce bitrate caps based on the server's plan.
        4.  Update the auto-reconnect logic to use the new plan-based priority settings.
        5.  Replace all remaining RadioBot branding with OmniFM.
    -   **Why fix this issue and what will be achieved with the fix?**: This is the user's primary goal. Completing this will result in a professional, modular, and monetizable product as specified.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: both

**In progress Task List**:
-   Task 1: Complete the RadioBot to OmniFM rebrand & v3 monetization system implementation.
    -   Where to resume: Refactoring the main application file, , to integrate and use all the newly created modules and enforce the strict permission model.
    -   What will be achieved with this?: A fully rebranded, modular, and professionally architected bot with a new server-seat-based licensing model, ready for market.
    -   Status: IN PROGRESS
    -   Should Test frontend/backend/both after fix?: both

**Upcoming and Future Tasks**
Upcoming Tasks:
-   (P0) Complete the  refactor to use new services and enforce permissions.
-   (P1) Implement the reconnect priority logic based on plan features.
-   (P1) Implement the audio quality/bitrate enforcement during playback.
-   (P2) Update the static website UI/copy in  and  to match the OmniFM branding and new pricing structure.
-   (P2) Create the  module for generating standardized upgrade messages in Discord.

Future Tasks:
-   (P3) Perform a full Quality Assurance pass to verify all plan limits, permissions, and pricing calculations are correct.
-   (P4) Refactor the static frontend in  into a modern React application to improve maintainability.

**Completed work in this session**
- **Bug Fix: Critical  Failures (RESOLVED)**
  - Fixed a bug where  would crash after a  by implementing a self-exec pattern that re-runs the script from a temporary copy.
  - Made the script robust by ensuring  is correctly set and  is always found.
- **Bug Fix: Auto-Reconnect on Restart (RESOLVED)**
  - Fixed a container restart loop caused by  attempting to remove a mounted volume.
  - Made all JSON store modules (, , etc.) and shell scripts (, ) robust against files being replaced by directory mounts from Docker.
  - Verified via logs that the auto-reconnect feature is now fully functional.
- **Bug Fix: Email self-signed certificate (RESOLVED)**
  - Added the  option to  to allow connections to a local mail server with self-signed certificates.
- **Feature: OmniFM Refactor (IN PROGRESS)**
  - Created new config files for the v3 monetization system:  and .
  - Created new core modules for entitlements and station management:  and .
  - Created new tiered station data files:  and .
  - Updated  to support the new seat-based licensing model.
  - Updated  to rebrand commands to OmniFM.

**Earlier issues found/mentioned but not fixed**
- None. All previously reported user issues were addressed before the current refactoring task began.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork**: Auto-Reconnect functionality.
- **Recurrence count**: 3+
- **Status**: RESOLVED. Logs confirmed the feature now works reliably after fixing the underlying container restart-loop issue.

**Code Architecture**
The architecture is being refactored into a more modular structure:


**Key Technical Concepts**
- **Backend**: Node.js, , Express.js
- **State Persistence**: Flat-file database using JSON files (, , ).
- **Architecture**: Refactoring from a monolithic  to a modular, service-oriented architecture with centralized configuration.
- **Monetization**: Implementing a seat-based licensing model with tiered features and pricing.

**key DB schema**
The  schema is being updated to support the new model:
-   ** (New Target Schema)**: 
-   ****: 
-   ****: 

**changes in tech stack**
- No new technologies, but a major architectural refactor is in progress.

**All files of reference**
*   **New/Created Files**:
    *   : Defines features for each subscription tier.
    *   : Defines pricing for plans, seats, and billing periods.
    *   : Core logic for checking a server's plan and feature access.
    *   : Manages access to stations based on plan.
    *    & : New tiered station lists.
*   **Critically Modified Files**:
    *   : The main application file, currently being refactored. **(CRITICAL)**
    *   : Updated to handle the new seat-based license structure.
    *   
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                              â•‘
  â•‘   Discord Radio Bot - Management & Settings  â•‘
  â•‘                                              â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m
  [0;31m[FAIL][0m docker fehlt. Bitte installieren. & 
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                           â•‘
  â•‘    Discord Radio Bot - Installer v4.0     â•‘
  â•‘    Zero-Lag Audio + Premium System         â•‘
  â•‘                                           â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m

[1mSchritt 1/6: Docker pruefen[0m
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[0;33m[WARN][0m Docker nicht gefunden.
[0;36m[INFO][0m Installiere Docker...
[0;32m[OK][0m   Docker installiert.
[0;31m[FAIL][0m docker compose Plugin fehlt.
  Installiere es mit: sudo apt-get install docker-compose-plugin: Made significantly more robust to handle updates and file system issues.
    *   : Fixed to prevent container restart loops.

**Areas that need refactoring**:
-    is the primary focus of the current refactoring effort.
-   The static frontend in  is a candidate for a future upgrade to a modern framework like React.

**key api endpoints**
-   : Will need to be updated to use the new  service.
-   : Will need to be updated to use the new  logic for creating/updating seat-based licenses.

**Critical Info for New Agent**
1.  **TOP PRIORITY**: You are in the middle of a massive refactoring and rebranding task. Your first and foremost goal is to complete it by modifying  to use all the new services and configs. The application is currently **non-functional**.
2.  **Follow the PRD**: The user's message #240 is the complete Product Requirements Document for this OmniFM task. Adhere to it strictly.
3.  **Language**: You MUST communicate with the user in **German**.
4.  **Resolved Issues**: The previously critical, recurring Auto-Reconnect and  script bugs are **FIXED**. Do not spend time investigating them. The user has confirmed the fixes.

**documents and test reports created in this job**
- /app/memory/PRD.md (will need a major update after the refactor is complete)
- Test reports were generated for previous bug fixes but are not relevant to the current refactoring task.

**Last 10 User Messages and any pending HUMAN messages**
- **User (240)**: Provided a detailed, multi-page PRD for a complete rebranding to OmniFM and a new v3 monetization system. This is the current source of truth for all work. **(IN PROGRESS)**
- **User (232-238)**: Instructed the agent to pull the latest code from a specific GitHub repository. **(Completed)**
- **User (226)**: Asked the agent to get the latest git state before giving further instructions. **(Completed)**
- **User (217-225)**: Reported a self-signed certificate error with the email test and confirmed the agent's proposed fix. **(Completed)**
- **User (216)**: Confirmed the  script seems to work now but reported the email test is failing. **(Partially Completed)**
- **User (209-215)**: Pointed out that the  script fix was incorrect, leading the agent to identify the  bug and resolve it. Also noted that the auto-reconnect now works. **(Completed)**
- **User (208)**: Provided logs showing the bot container was not active according to , despite logs showing the bot was running. This led to the discovery of the  bug. **(Completed)**

**Project Health Check:**
-   **Broken**: The application is in a non-functional state mid-refactor. The core  file is out of sync with the new modular architecture.

**3rd Party Integrations**
-   **Discord**:  - Requires user-provided bot tokens.
-   **Stripe**:  - Logic only for pricing; no active integration.
-   **Nodemailer**: For SMTP emails, requires user-provided SMTP credentials.

**Testing status**
-   Testing agent used after significant changes: NO (Not yet, as the refactor is incomplete).
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: None.
-   Known regressions: None. The main regression (auto-reconnect) was fixed.

**Credentials to test flow:**
-   Bot credentials must be set in the  file.
-   Stripe API keys must be configured via 
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                              â•‘
  â•‘   Discord Radio Bot - Management & Settings  â•‘
  â•‘                                              â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m
  [0;31m[FAIL][0m docker fehlt. Bitte installieren..
-   SMTP credentials must be configured via 
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                              â•‘
  â•‘   Discord Radio Bot - Management & Settings  â•‘
  â•‘                                              â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m
  [0;31m[FAIL][0m docker fehlt. Bitte installieren..

**What agent forgot to execute**
- The agent has not forgotten anything; it is simply in the middle of a very large, multi-step task and has correctly identified the next step (refactoring ).</analysis>
