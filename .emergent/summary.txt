<analysis>**original_problem_statement:**
The user's initial goal was to redesign their Discord Radio Bot's web interface. This evolved into a full-scale project overhaul focused on professional-grade features.

The most recent user requests are:
1.  **Eliminate Audio Lag**: The user has repeatedly emphasized that fixing audio lag and stuttering is the absolute highest priority. The bot must provide a smooth, zero lag listening experience.
2.  **Robust Auto-Reconnect**: After an update or restart, the bot must automatically remember which voice channel it was in, for which server, playing which station, and at what volume, and seamlessly reconnect itself without any user intervention.
3.  **Fix Auto-Reconnect Disabling Bug**: The currently implemented auto-reconnect feature incorrectly disables itself upon temporary network drops, treating them as manual kicks.
4.  **Server-Specific Player Status**: The web interface and bot status should not show a global player status, but rather what is specifically playing on the Discord server (guild) the user is on.
5.  **Secure Premium Bot Invites**: Free users must not be able to invite premium-tier bots. An intelligent system is required to lock these bots until a user has purchased a premium plan for their server.
6.  **Add Discord Support Link**: A prominent link to the user's support Discord server () must be added throughout the web interface for easy user access.
7.  **Refine Install/Update Scripts**: The  and  scripts needed to be more robust, with bug fixes and feature enhancements like moving the add bot flow to the update script.

**User's preferred language**: German. The next agent MUST respond in German.

**what currently exists?**
The project is a multi-bot Discord radio streaming application with a Node.js backend (, ), a React frontend for preview, and a static JS/HTML/CSS frontend for production. A full premium system using Stripe is implemented, along with file-based persistence for licenses () and bot session state (). The agent has implemented features for audio optimization, auto-reconnect, secure premium bot invites, and UI enhancements. However, the two most critical featuresâ€”audio stability and auto-reconnectâ€”are currently not working as intended.

**Last working item**:
- Last item agent was working: Debugging a critical flaw in the auto-reconnect logic. The user provided logs showing  after a connection drop. The agent correctly identified the bug in  (within the  event handler), where any voice channel disconnection (even temporary ones) was being incorrectly treated as a manual user action, which then permanently disabled the reconnect feature for that session.
- Status: IN PROGRESS
- Agent Testing Done: N
- Which testing method agent to use? backend testing agent. The fix requires modifying the bot's core lifecycle logic in . The test would involve starting the bot, having it join a voice channel, simulating a network interruption or forcing a temporary disconnect, and verifying from the logs that the bot attempts to reconnect instead of disabling the feature.
- User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Auto-Reconnect feature is incorrectly disabled on temporary connection drops.
-   Issue 2: (P1) Audio stream is unstable, causing  errors and perceived lag.

Issues Detail:
-   **Issue 1: Auto-Reconnect incorrectly disabled**
    -   **Attempted fixes**: None. The bug was just diagnosed.
    -   **Next debug checklist**:
        -   Modify the  listener in  (around lines 582-618).
        -   The logic  is too broad. It needs to differentiate between a manual disconnect (e.g., a user kicking the bot) and an automatic/network-related disconnect.
        -   A potential fix is to only set  if the bot is moved by a user, not when the connection simply drops. A more robust reconnect attempt should be triggered on connection loss.
    -   **Why fix this issue and what will be achieved with the fix?**: This is critical for the user's requested auto-reconnect feature. Fixing it will ensure the bot is resilient to network fluctuations and can successfully restore its session after a restart or temporary drop, as intended.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test backend/both after fix?**: backend
-   **Issue 2: Audio stream instability and timeouts**
    -   **Attempted fixes**: The agent modified  arguments in  (e.g., , ) and  to .
    -   **Why it didn't work**: The user's final logs () still show a flood of  messages, indicating the root cause of the stream instability was not addressed by tweaking  arguments alone. The  of 5 seconds might be too aggressive for unstable streams.
    -   **Next debug checklist**:
        -   Review the entire audio pipeline in  again, specifically the  and  functions.
        -   Investigate the 's  event handler. The current logic just logs and attempts a restart, which may be causing a restart loop.
        -   Consider increasing the  input timeout () from  (5s) to a more lenient value (e.g., 15-20s) to handle slow-to-start radio streams.
        -   Examine the resource creation: . Ensure the stream source itself is stable.
    -   **Why fix this issue and what will be achieved with the fix?**: This directly addresses the user's #1 priority: eliminating audio lag. A stable audio stream is the core function of the application.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test backend/both after fix?**: backend

**In progress Task List**:
-   No separate tasks; all current work is captured in the issue list above.

**Upcoming and Future Tasks**
Upcoming Tasks:
-   **(P0) Implement Auto-Reconnect Fix**: Apply the fix for the auto-reconnect bug (Issue 1).
-   **(P1) Resolve Audio Timeouts**: Re-investigate and fix the audio player timeout errors (Issue 2).
-   **(P2) User Validation**: After fixing both P0 and P1, guide the user to test both audio quality and the auto-reconnect functionality thoroughly.

Future Tasks:
-   **(P3) Automate Dual-Frontend Sync**: Implement a build step (e.g., yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. in the root) that automatically compiles the React app in  and outputs the static files to the  directory, eliminating manual synchronization.
-   **(P4) Refactor **: Break down the massive  file into smaller, more manageable modules (e.g., , , , ).

**Completed work in this session**
- **Feature: Auto-Reconnect State Persistence**:
    - Created  and  to save and load bot sessions (guild, channel, station).
    - Implemented  and  logic within the bot's lifecycle.
    - Configured Docker () and scripts (, ) to handle the new state file.
- **Feature: Secure Premium Bot Invites**:
    - Added a  environment variable to define bot access levels (               total        used        free      shared  buff/cache   available
Mem:        16358508     8785176     2186752       45820     5689228     7573332
Swap:              0           0           0, , ).
    - Updated the frontend (, ) to show a lock icon instead of an invite button for inaccessible premium bots.
    - Added a secure  endpoint to provide invite links only to guilds with a valid subscription.
    - Updated  and  to configure the  for new bots.
- **Feature: Discord Support Link Integration**:
    - Added the user's Discord server link () to the web UI's Navbar, Hero section, Premium section, and Footer on both the React and static frontends.
    - Included the support link in the  Discord command's response.
- **Critical Bug Fixes**:
    - Fixed a  by removing a duplicate function definition in  and adding the correct exports in .
    - Fixed a  crash by making the  callback in  an  function.
    - Fixed a shell script error () in .
- **Script and CLI Enhancements**:
    - Created a new CLI tool  to manage premium licenses (, , , , ).
    - Overhauled  to support adding/removing bots and to be more robust.
- **Feature: Server-Specific Data Display**:
    - Enhanced the  endpoint to include , showing per-server activity.
    - Updated the web UI () to display this guild-specific information.

**Earlier issues found/mentioned but not fixed**
- The core issue of audio lag and player timeouts () persists despite attempts to fix it. This is now the highest priority technical debt.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork**: Audio lag and performance issues.
- **Recurrence count**: 2+
- **Status**: IN PROGRESS

**Code Architecture**


**Key Technical Concepts**
- **Bot Backend**: Node.js with  and .
- **Web Server**: Express.js server integrated into .
- **Payment Processing**: Stripe for subscriptions.
- **License System**: File-based () system for premium guilds.
- **State Persistence**: A  file stores active sessions (guild, channel, station, volume) to enable auto-reconnect after restarts, managed by .
- **Development Stack**: Dual frontend with React/FastAPI for preview and a static Node.js/HTML/JS app for production.

**key DB schema**
- **premium.json**: 
- **bot-state.json**: 

**changes in tech stack**
- No new technologies were added. The architecture was extended with a new state management file ().

**All files of reference**
- : The central file for both pending issues. Contains the flawed  handler and the audio pipeline that is causing timeouts.
- : Helper module for the auto-reconnect feature.
- : The data file for the auto-reconnect feature.
- , 
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                           â•‘
  â•‘   Discord Radio Bot - Update & Manage     â•‘
  â•‘                                           â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m

[0;31m[FAIL][0m docker fehlt. Bitte installieren.: Core operational scripts, updated multiple times.
- : Updated to include persistent volumes for state.
- : Contains the frontend logic for locking premium bot invites.

**Areas that need refactoring**:
- The manual synchronization between  and  is inefficient. An automated build process is needed.
-  has grown excessively large and complex. It should be broken down into smaller, single-responsibility modules to improve maintainability.

**key api endpoints**
- : Creates a Stripe checkout session.
- : Handles Stripe payment events.
- : Checks a guild's premium status.
- : **New endpoint** to securely provide invite links for premium bots to authorized guilds.

**Critical Info for New Agent**
1.  **PRIORITY 1: FIX AUTO-RECONNECT**: The immediate task is to fix the bug in the  handler in . The bot must not disable auto-reconnect on temporary network drops. It should only do so on a confirmed manual action (like a user kicking it).
2.  **PRIORITY 2: FIX AUDIO LAG/TIMEOUTS**: After fixing the reconnect logic, you must address the  errors. This is the user's biggest pain point. Simply tweaking  args was not enough. A deeper investigation into the audio pipeline and error handling is required.
3.  **The user is at the end of their patience**. The next response must acknowledge the two critical bugs and deliver a working solution for both. Finish the task completely after fixing and verifying these two issues.

**documents and test reports created in this job**
- /app/memory/PRD.md
- Multiple test reports in , with the last one being .

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Asks why auto-reconnect is disabled and provides logs showing both the reconnect failure and persistent audio player timeouts. **(CURRENT BLOCKER)**
2.  **User**: Demands a final, stable version, emphasizing that audio lag and auto-reconnect are the last two things to fix before finishing. **(PENDING)**
3.  **User**: Reports a major logic flaw: premium bots can be invited by anyone. **(COMPLETED)**
4.  **User**: Expresses frustration with update errors and requests the addition of a Discord support link. **(COMPLETED)**
5.  **Agent**: Declares the task finished after passing automated tests. **(Incorrect, user found more bugs)**
6.  **User**: Reports a critical bot crash (). **(COMPLETED)**
7.  **User**: Reports a critical bot crash () and several new feature requests/bug reports related to server-specific info and install scripts. **(COMPLETED)**
8.  **Agent**: Declares the task finished after passing automated tests. **(Incorrect, user found more bugs)**
9.  **User**: Gives broad approval to make everything really professional, mentioning audio quality as the most important thing. **(Acknowledged)**
10. **Agent**: Proposes an initial plan to implement the premium system and audio optimizations. **(Superseded)**

**Project Health Check:**
- **Broken**: The auto-reconnect feature is critically flawed. The audio streaming pipeline is unstable and prone to timeouts, failing the user's primary requirement.

**3rd Party Integrations**
- **Discord**: . Requires User API Keys ( file).
- **Stripe**: . Requires User API Keys (configured via ).

**Testing status**
- Testing agent used after significant changes: YES. However, the automated tests failed to catch the critical runtime issues (reconnect logic bug, audio timeouts), proving that real-world scenario testing is required for these problems.
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created: None.
- Known regressions: The auto-reconnect feature is a regression from its intended functionality due to the bug.

**Credentials to test flow:**
- Bot credentials must be in the  file (, , etc.).
- Stripe functionality requires the user to run 
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘   Stripe API Key - Einrichtung        â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m

  Fuer Stripe-Zahlungen brauchst du einen API-Key.
  Hol dir deinen unter: [0;36mhttps://dashboard.stripe.com/apikeys[0m

  [0;33mHinweis:[0m Nutze erst den [1mTest-Key[0m (sk_test_...) zum Testen! and provide their own Stripe Secret Key and Public Key.

**What agent forgot to execute**
- The agent failed to fully resolve the user's primary complaint about audio lag; the implemented fixes were insufficient.
- The agent introduced a critical bug into the new auto-reconnect feature, making it non-functional in real-world conditions.</analysis>
