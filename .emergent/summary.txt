<analysis>**original_problem_statement:**
The user has requested a complete rebranding of an existing Discord Radio Bot to a new product called OmniFM. This includes a comprehensive overhaul of the architecture and monetization model to a professional, scalable system. The full, up-to-date requirements are detailed below.

**PRODUCT REQUIREMENTS (Monetization System v3 & Rebrand - per user message #401):**

1.  **Rebrand**: Systematically replace all instances of RADIOBOT with OmniFM (UI, logs, bot presence).
2.  **Plans & Features**: Implement a strict three-tier system (free, pro, ultimate) with feature flags managed in a central config.
    *   **free**: 2 bots, standard audio (64k), standard reconnect.
    *   **pro**: 8 bots, HQ audio (128k), priority reconnect, premium stations.
    *   **ultimate**: 16 bots, Ultra HQ audio (320k), instant reconnect, premium stations, custom station URLs.
3.  **Server-Based Licensing**: Shift to a server-seat bundle model (1, 2, 3, or 5 servers). A single license covers multiple servers.
4.  **Station Tier System**:
    *   20                total        used        free      shared  buff/cache   available
Mem:        16358512     5794376     5114744       45564     5751688    10564136
Swap:              0           0           0 stations.
    *   100  stations.
    *    plan includes all stations plus server-specific custom station URLs.
5.  **Command Permission Matrix**: Strictly enforce plan-based access for all commands (, , etc.), denying access with a clear upgrade message.
6.  **Reconnect Priority**: Implement tiered reconnect delays: standard (free), faster (pro), and instant (ultimate).
7.  **Audio Quality Enforcement**: **Crucially, the audio bitrate is determined by the server's plan, NOT the station being played.** Free servers get 64k, Pro get 128k, and Ultimate get 320k on ANY station.
8.  **Pricing System**: Implement a pricing calculator for plans, seat bundles, and billing periods (monthly/yearly) with a yearly discount (pay for 10 months).
9.  **Website Copy Update**: Update the web frontend to reflect OmniFM branding, features, and the new seat-based pricing tiers.
10. **Upgrade Flow**: Create a reusable module for sending standardized upgrade embeds within Discord when a user hits a paywall.

**User's preferred language**: German. The next agent MUST respond in German.

**what currently exists?**
The agent has successfully completed the massive RadioBot to OmniFM rebranding across the Node.js backend, shell scripts, and both a legacy static frontend and a new React frontend. The v3 monetization system, including tiered plans, seat-based licensing, and permission enforcement, is almost fully implemented. A major round of UI fixes was just completed based on user feedback, adding a server-seat selector to the checkout, displaying station tier badges (FREE/PRO), and correcting the pricing display. The application is largely functional, pending one critical logic fix.

**Last working item**:
- Last item agent was working: Addressing the user's final, critical feedback (message #401): the audio bitrate must be enforced based on the server's **plan**, not the station's properties. The agent had correctly identified the issue and was about to modify the audio playback logic.
- Status: IN PROGRESS
- Agent Testing Done: N
- Which testing method agent to use? backend testing agent. A small  script that calls the relevant backend functions could also verify the logic quickly. After the fix, a full regression test using  is recommended.
- User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Plan-Based Bitrate Enforcement is Incorrect.

Issues Detail:
-   **Issue 1: Plan-Based Bitrate Enforcement is Incorrect**
    -   **Attempted fixes**: The agent identified the problem but has not yet implemented a fix.
    -   **Next debug checklist**:
        1.  Open .
        2.  Locate the  function.
        3.  Find where  is called and its options are set (likely  or ).
        4.  Replace the current logic which uses the station's bitrate (e.g., ) with a call to get the bitrate from the server's plan.
        5.  Use the  helper, which correctly sources the bitrate from , to set the bitrate for the audio stream.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a core tenet of the monetization model and was explicitly flagged as incorrect by the user. Fixing it will align the bot's behavior with the product requirements.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: backend

**In progress Task List**:
- None.

**Upcoming and Future Tasks**
Upcoming Tasks:
-   (P1) **Full QA Pass**: As requested by the user, perform a manual verification of all plan limits, permissions, and pricing on a real Discord server.
-   (P2) **Deploy Commands**: Run the  script to register the updated German command descriptions with Discord.
-   (P2) **Verify Docker Service Names**: Check  and test that containers can be run with new service names ( instead of ).

Future Tasks:
-   **Consolidate Frontends**: Refactor the web presence by removing the legacy static site in  and having the backend serve the modern React app from .
-   **Admin Dashboard**: Build an interface for license management.
-   **Subscription Automation**: Upgrade the payment system from one-time payments to recurring subscriptions via Stripe.

**Completed work in this session**
- **Rebranding**: Completed the RadioBot -> OmniFM rebrand across the entire project (backend, frontend, scripts).
- **V3 Monetization System**: Implemented tiered plans, seat-based licensing, tiered stations, and command permissions.
- **Frontend Overhaul (Static & React)**:
    - Added station tier badges (FREE/PRO) and a tier filter to the station list.
    - Implemented a server-seat selector in the checkout modal.
    - Added a detailed seat-based pricing table.
    - Corrected all pricing logic and display formats.
    - Fixed all branding issues identified by the user (e.g., RADIOBOT in navbar).
- **API Updates**: Updated , , and  to support seats, tiers, and new pricing.
- **Testing**: Performed a full, successful E2E test run via  which confirmed the stability of all features prior to the discovery of the bitrate logic bug.

**Earlier issues found/mentioned but not fixed**
- None.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork**: Auto-Reconnect functionality.
- **Recurrence count**: 3+
- **Status**: RESOLVED.

**Code Architecture**


**Key Technical Concepts**
- **Backend**: Node.js, , Express.js
- **Frontend**: A legacy static HTML/JS site in  and a modern React app in .
- **State Persistence**: Flat-file database using JSON files.
- **Architecture**: Refactored from a monolithic  to a modular, service-oriented architecture.
- **Monetization**: Tiered (free/pro/ultimate) seat-based licensing model.

**key DB schema**
-   ****: 
-   ****: 
-   ****: 

**changes in tech stack**
- A new React frontend was introduced in , creating a dual-frontend situation that needs future consolidation.

**All files of reference**
*   **Critically Modified Files**:
    *   : The core application logic. **This is where the next change needs to happen.**
    *   : Contains the bitrate values per plan.
    *   : Contains the frontend checkout and pricing UI.
    *   : Contains the frontend station list UI.
    *    & : Legacy frontend files, also updated.
*   **Key New Files**:
    *   : Core logic for checking a server's plan and feature access.
    *   : Manages access to stations based on plan.
    *   : Generates localized Discord upgrade messages.

**Areas that need refactoring**:
-   **Dual Frontends**: The project has both a legacy static site () and a new React app (). This is confusing and should be consolidated into a single React application. The old  directory should be deprecated or removed.
-   The role of  should be re-evaluated. An Express static server within the Node.js application is a more conventional choice for serving the React build.

**key api endpoints**
-   : Returns stations list, now includes  and is sorted.
-   : Returns the full pricing structure.
-   : Creates a Stripe checkout session, now accepts .

**Critical Info for New Agent**
1.  **TOP PRIORITY**: Your first task is to fix the audio bitrate logic. Bitrate MUST be determined by the server's plan (Free=64k, Pro=128k, Ultimate=320k), not the station's metadata. This change needs to be made in the  function in .
2.  **Language**: You MUST communicate with the user in **German**.
3.  **Context**: The project is at the very end of a massive refactoring effort. The user is now performing final acceptance testing and has found this last critical bug. Address it, test it, and then proceed with the final QA pass.

**documents and test reports created in this job**
-  (has been updated)
-  (successful test run before the bitrate bug was found)

**Last 10 User Messages and any pending HUMAN messages**
-   **User (401)**: Stated that the bitrate logic is wrong. Quality must be based on the plan (free=64k, pro=128k, ultimate=320k) for *all* stations. Provided the full, updated PRD again for clarity. **(This is the current P0 task)**.
-   **User (238)**: Sent a screenshot showing the website was missing the seat selector, station tier labels, and had incorrect pricing. Requested a full fix. **(Completed)**.
-   **Agent (before 238)**: Prematurely finished the task, believing the implementation was complete. **(Corrected by user feedback)**.

**Project Health Check:**
-   **Working with Critical Bug**: The application is stable and the UI is complete, but a core monetization feature (plan-based audio quality) is implemented incorrectly.

**3rd Party Integrations**
-   **Discord**:  - Requires user-provided bot token.
-   **Stripe**:  - Logic for checkout session creation exists. Requires user-provided keys.
-   **Nodemailer**: For SMTP emails, requires user-provided credentials.

**Testing status**
-   Testing agent used after significant changes: YES (A full pass was completed successfully before the latest bug was reported).
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: None
-   Known regressions: None

**Credentials to test flow:**
-   Bot credentials must be set in the  file.
-   Stripe API keys can be configured via 
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                              â•‘
  â•‘   OmniFM - Management & Settings            â•‘
  â•‘                                              â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m
  [0;31m[FAIL][0m docker fehlt. Bitte installieren..
-   SMTP credentials can be configured via 
[0;36m[1m
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                              â•‘
  â•‘   OmniFM - Management & Settings            â•‘
  â•‘                                              â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0m
  [0;31m[FAIL][0m docker fehlt. Bitte installieren..

**What agent forgot to execute**
- The agent incorrectly implemented the audio quality feature. It was tied to the station's properties instead of being dynamically enforced based on the server's active subscription plan, as required by the user's PRD.</analysis>
